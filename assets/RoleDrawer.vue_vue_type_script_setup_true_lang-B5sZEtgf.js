var W=Object.defineProperty;var x=Object.getOwnPropertySymbols;var H=Object.prototype.hasOwnProperty,Q=Object.prototype.propertyIsEnumerable;var S=(e,t,a)=>t in e?W(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,K=(e,t)=>{for(var a in t||(t={}))H.call(t,a)&&S(e,a,t[a]);if(x)for(var a of x(t))Q.call(t,a)&&S(e,a,t[a]);return e};var w=(e,t,a)=>new Promise((l,i)=>{var r=p=>{try{s(a.next(p))}catch(c){i(c)}},n=p=>{try{s(a.throw(p))}catch(c){i(c)}},s=p=>p.done?l(p.value):Promise.resolve(p.value).then(r,n);s((a=a.apply(e,t)).next())});import{b as X,c as J}from"./useForm-BzgFlAKs.js";import{b as Y,as as Z,ar as ee,aW as te,q as ae,bt as se,a as D,v as oe,bm as ne,B as re}from"./entry/index-BPNJPE-d-1727367563404.js";import{u as q,c as ie}from"./role-DKToNsWF.js";import{l as le,d as ue,f as y,w as ce,c as de,u,ae as pe,S as fe,U as me,af as he,X as g,k as h,G as ye,ac as ge,a0 as ve}from"./vue-D0RdBkD6.js";import{Q as we,E as ke,b0 as T,a8 as be}from"./antd-CnnxMtH0.js";import{a as De,B as F}from"./index-CaWdKrxn.js";import{_ as Me,a as Ae}from"./index-DDNUB-iW.js";const{t:d}=Y(),Oe=[{title:d("sys.role.roleName"),dataIndex:"trans",width:50},{title:d("sys.role.roleValue"),dataIndex:"code",width:20},{title:d("common.status"),dataIndex:"status",width:50,customRender:({record:e})=>(Reflect.has(e,"pendingStatus")||(e.pendingStatus=!1),le(we,{checked:e.status===1,checkedChildren:d("common.on"),unCheckedChildren:d("common.off"),loading:e.pendingStatus,onChange(t,a){const{createMessage:l}=ee();if(e.id==1){l.warn(d("sys.role.adminStatusChangeForbidden"));return}e.pendingStatus=!0;const i=t?1:2;q({id:e.id,status:i}).then(()=>{e.status=i}).finally(()=>{e.pendingStatus=!1})}}))},{title:d("common.remark"),dataIndex:"remark",width:50},{title:d("common.createTime"),dataIndex:"createdAt",width:50,customRender:({record:e})=>Z(e.createdAt)}],Ie=[{field:"id",label:"ID",component:"Input",show:!1},{field:"name",label:d("sys.role.roleName"),required:!0,component:"Input",rules:[{max:30}]},{field:"sort",label:d("sys.menu.order"),defaultValue:0,component:"InputNumber",required:!0},{field:"code",label:d("sys.role.roleValue"),required:!0,component:"Input",rules:[{min:1,max:20}]},{field:"defaultRouter",label:d("sys.role.defaultRouter"),required:!0,component:"Input",rules:[{max:80}]},{field:"status",label:d("common.status"),component:"RadioButtonGroup",defaultValue:1,componentProps:{options:[{label:d("common.on"),value:1},{label:d("common.off"),value:0}]}},{label:d("common.remark"),field:"remark",component:"InputTextArea",rules:[{max:200}]}];function _e(e){var r,n;const t=[],a=[];if(e.length===0)return a;const l=new Map,i=new Map;for(let s=0;s<e.length;s++)l.set(e[s].group,e[s].serviceName),i.set(e[s].serviceName,!0);for(const s of l.keys()){const p={title:s,key:s,children:[]};for(let c=0;c<e.length;c++)e[c].group==s&&((r=p.children)==null||r.push({title:e[c].trans,key:e[c].id,disableCheckbox:e[c].isRequired}));a.push(p)}for(const s of i.keys()){const p={title:s,key:s,children:[]};for(let c=0;c<a.length;c++)l.get(a[c].title)===s&&((n=p.children)==null||n.push(te(a[c])));t.push(p)}return t}function Ce(e,t){const a=[];for(let r=0;r<e.length;r++)typeof e[r]=="number"&&a.push(e[r]);t.sort(function(r,n){return r.id!==void 0&&n.id!==void 0?r.id-n.id:1}),a.sort(function(r,n){return r-n});const l=[];let i=0;for(let r=0;r<t.length;r++)t[r].id===a[i]&&(l.push({path:t[r].path,method:t[r].method}),i++);return l}function N(e,t){const a=new Map,l=[],i=[];t.forEach(function(n,s){n.isRequired&&i.push(n.id)});for(let n=0;n<t.length;n++)a.set(t[n].path+t[n].method,t[n].id);for(let n=0;n<e.length;n++)l.push(a.get(e[n].path+e[n].method));return ae(se(l,i))}const Re=e=>D.post({url:"/sys-api/api/list",params:e}),xe=e=>D.post({url:"/sys-api/authority/api/role",params:e}),Se=(e,t="notice")=>D.post({url:"/sys-api/authority/api/create_or_update",params:e},{errorMessageMode:t,successMessageMode:t}),Ke=(e,t="notice")=>D.post({url:"/sys-api/authority/menu/create_or_update",params:e},{errorMessageMode:t,successMessageMode:t}),Te=e=>D.post({url:"/sys-api/authority/menu/role",params:e}),Ee=ue({__name:"RoleDrawer",emits:["success","register"],setup(e,{emit:t}){const a=t,l=y(!0),{t:i}=oe.useI18n(),r=y("1");let n={code:0,msg:"",data:{total:0,data:[]}};const s=y(!1),p=()=>{s.value=!0},c=y(null),I=y([]);function k(){const o=u(c);if(!o)throw new Error("menu tree is null!");return o}function U(){return w(this,null,function*(){try{I.value=[];const o=yield ne();I.value=Ae(o.data.data,{idKeyField:"id",parentKeyField:"parentId",childrenKeyField:"children",valueField:"id",labelField:"trans"});const f=yield M(),v=yield Te({id:Number(f.id)});k().setCheckedKeys(v.data.menuIds),k().expandAll(!0)}catch(o){}})}const b=y([]),_=y([]);function V(){return w(this,null,function*(){try{_.value=[];const o=yield Re({page:1,pageSize:1e4});n=o;const f=_e(o.data.data);for(const z in f)_.value.push(f[z]);const v=yield M(),m=yield xe({id:Number(v.id)});m.data.data===null?b.value=N([],o.data.data):b.value=N(m.data.data,o.data.data)}catch(o){}})}ce(s,()=>{s.value===!0&&(U(),V())});const[B,{resetFields:P,setFieldsValue:L,validate:O,getFieldsValue:M}]=X({labelWidth:160,baseColProps:{span:24},layout:"vertical",schemas:Ie,showActionButtonGroup:!1}),[E,{setDrawerProps:C,closeDrawer:A}]=De(o=>w(this,null,function*(){yield P(),C({confirmLoading:!1}),l.value=!!(o!=null&&o.isUpdate),u(l)&&(yield L(K({},o.record)))})),G=de(()=>u(l)?i("sys.role.editRole"):i("sys.role.addRole"));function R(){s.value=!1,A()}function $(){return w(this,null,function*(){const o=yield O();C({confirmLoading:!0}),o.id=u(l)?Number(o.id):0,(u(l)?yield q(o):yield ie(o)).code===0&&(s.value=!1,A(),a("success")),C({confirmLoading:!1})})}function j(){return w(this,null,function*(){if(r.value==="1"){const o=yield M();(yield Ke({roleId:Number(o.id),menuIds:re(k().getCheckedKeys())?k().getCheckedKeys():k().getCheckedKeys().checked})).code===0&&(s.value=!1,A())}else{const o=Ce(b.value,n.data.data),f=yield M();(yield Se({roleId:Number(f.id),data:o})).code===0&&(s.value=!1,A())}})}return(o,f)=>{const v=pe("a-button");return fe(),me(u(F),ve(o.$attrs,{onRegister:u(E),showFooter:"",title:G.value,width:"35%",onOk:$,onClose:R}),he({default:g(()=>[h(u(J),{onRegister:u(B)},null,8,["onRegister"]),h(u(F),{open:s.value,"onUpdate:open":f[2]||(f[2]=m=>s.value=m),title:u(i)("sys.authority.authorityManagement"),width:"25%",showFooter:"",closable:!0,onOk:j,onClose:R},{default:g(()=>[h(u(ke),{activeKey:r.value,"onUpdate:activeKey":f[1]||(f[1]=m=>r.value=m),centered:""},{default:g(()=>[h(u(T),{key:"1",tab:u(i)("sys.authority.menuAuthority")},{default:g(()=>[h(u(Me),{checkable:"",treeData:I.value,checkStrictly:!0,noPadding:!0,ref_key:"treeMenuRef",ref:c},null,8,["treeData"])]),_:1},8,["tab"]),h(u(T),{key:"2",tab:u(i)("sys.authority.apiAuthority")},{default:g(()=>[h(u(be),{"checked-keys":b.value,"onUpdate:checkedKeys":f[0]||(f[0]=m=>b.value=m),checkable:"","tree-data":_.value},null,8,["checked-keys","tree-data"])]),_:1},8,["tab"])]),_:1},8,["activeKey"])]),_:1},8,["open","title"])]),_:2},[l.value?{name:"extra",fn:g(()=>[h(v,{type:"primary",style:{"margin-right":"8px"},onClick:p},{default:g(()=>[ye(ge(u(i)("sys.authority.authorityManagement")),1)]),_:1})]),key:"0"}:void 0]),1040,["onRegister","title"])}}});export{Ee as _,Oe as c};
